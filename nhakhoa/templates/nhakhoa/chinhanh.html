{% extends 'nhakhoa/base.html' %}
{% load static %}

{% block title %}Hệ thống chi nhánh - GIS{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div class="container" style="display: flex; gap: 30px; height: 85vh; padding-top: 20px; padding-bottom: 20px;">
    
    <div style="flex: 1; overflow-y: auto; padding-right: 10px;">
        <h2 style="text-align: left; color: #28a745;">HỆ THỐNG PHÒNG KHÁM</h2>
        <p style="margin-bottom: 20px; color: #666;">Chọn chi nhánh để xem vị trí trên bản đồ GIS</p>
        
        {% for cn in ds_cn %}
        <div class="branch-item" 
            onclick="zoomToLocation({{ cn.vi_do|stringformat:'f' }}, {{ cn.kinh_do|stringformat:'f' }}, '{{ cn.ten_chi_nhanh }}')"
             style="border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; cursor: pointer; transition: 0.3s; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
            
            <h3 style="font-size: 18px; color: #0d6efd; margin-top: 0;">{{ cn.ten_chi_nhanh }}</h3>
            <p style="margin-bottom: 5px; font-size: 14px; color: #555;">
                <i class="fas fa-map-marker-alt" style="color: red;"></i> {{ cn.dia_chi }}
            </p>
            <div style="font-size: 12px; color: #888; font-family: monospace;">
                Lat: {{ cn.vi_do }} | Lng: {{ cn.kinh_do }}
            </div>
            
            <button style="margin-top: 10px; padding: 5px 15px; background: #e9ecef; border: none; border-radius: 20px; color: #333; font-size: 13px; cursor: pointer;">
                <i class="fas fa-search-location"></i> Xem trên bản đồ
            </button>
        </div>
        {% empty %}
            <p>Chưa có dữ liệu chi nhánh.</p>
        {% endfor %}
    </div>

    <div style="flex: 2; background: #e9ecef; border-radius: 15px; position: relative; overflow: hidden; border: 2px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
        <div id="map" style="width: 100%; height: 100%;"></div>
    </div>

</div>

<script>
    // 1. Khởi tạo bản đồ (Tọa độ trung tâm TP.HCM)
    var map = L.map('map').setView([10.762622, 106.660172], 12);

    // 2. Thêm lớp nền bản đồ (OpenStreetMap - Miễn phí)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    // 3. Tạo biểu tượng marker đẹp hơn (Optional)
    var customIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', // Icon định vị
        iconSize: [38, 38],
        iconAnchor: [19, 38],
        popupAnchor: [0, -38]
    });

    // 4. Vòng lặp Javascript để Ghim các điểm từ Database lên bản đồ
    // (Django sẽ render dữ liệu vào giữa đoạn script này)
    {% for cn in ds_cn %}
        L.marker([{{ cn.vi_do }}, {{ cn.kinh_do }}], {icon: customIcon})
         .addTo(map)
         .bindPopup("<b>{{ cn.ten_chi_nhanh }}</b><br>{{ cn.dia_chi }}");
    {% endfor %}

    // 5. Hàm xử lý khi bấm vào danh sách bên trái
    function zoomToLocation(lat, lng, name) {
        // Hiệu ứng bay tới vị trí (FlyTo)
        map.flyTo([lat, lng], 16, {
            animate: true,
            duration: 1.5 // Thời gian bay 1.5 giây
        });

        // Tự động mở Popup tên chi nhánh
        L.popup()
            .setLatLng([lat, lng])
            .setContent("<b>" + name + "</b>")
            .openOn(map);
    }
</script>

<style>
    /* Hiệu ứng hover cho danh sách */
    .branch-item:hover {
        background-color: #f8f9fa !important;
        border-color: #0d6efd !important;
        transform: translateY(-2px);
    }
</style>
{% endblock %}